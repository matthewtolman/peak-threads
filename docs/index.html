<!DOCTYPE html><html class="default" lang="en" data-base="./"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>peaks-threads</title><meta name="description" content="Documentation for peaks-threads"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script defer src="assets/main.js"></script><script async src="assets/icons.js" id="tsd-icons-script"></script><script async src="assets/search.js" id="tsd-search-script"></script><script async src="assets/navigation.js" id="tsd-nav-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="index.html" class="title">peaks-threads</a><div id="tsd-toolbar-links"></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><h1>peaks-threads</h1></div><div class="tsd-panel tsd-typography"><h1 id="threads-js" class="tsd-anchor-link">Threads JS<a href="#threads-js" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h1>
<p>Threads JS (or threads for short) is a JavaScript/TypeScript threading library for the browser. It allows sites to spawn threads (via the Workers API)
and then easily communicate with those threads. This includes sending work, sharing or transferring resources, pooling threads,
and having locks, wait groups, condition variables, and other shared memory synchronization mechanisms (note: for the shared
memory to work, you must be in a secure context and be cross-origin isolated!).</p>
<h2 id="general-usage" class="tsd-anchor-link">General Usage<a href="#general-usage" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2>
<p>Here is an example of general usage.</p>
<pre><code class="html"><span class="hl-0">&lt;!-- index.html --&gt;</span><br/><span class="hl-1">&lt;</span><span class="hl-2">button</span><span class="hl-3"> </span><span class="hl-4">id</span><span class="hl-3">=</span><span class="hl-5">&quot;btn&quot;</span><span class="hl-1">&gt;</span><span class="hl-3">Click Me!</span><span class="hl-1">&lt;/</span><span class="hl-2">button</span><span class="hl-1">&gt;</span><br/><span class="hl-1">&lt;</span><span class="hl-2">div</span><span class="hl-3"> </span><span class="hl-4">id</span><span class="hl-3">=</span><span class="hl-5">&quot;result&quot;</span><span class="hl-1">&gt;&lt;/</span><span class="hl-2">div</span><span class="hl-1">&gt;</span><br/><br/><span class="hl-1">&lt;</span><span class="hl-2">script</span><span class="hl-6"> </span><span class="hl-4">src</span><span class="hl-6">=</span><span class="hl-5">&quot;/public/threads.iife.js&quot;</span><span class="hl-1">&gt;&lt;/</span><span class="hl-2">script</span><span class="hl-1">&gt;</span><br/><span class="hl-1">&lt;</span><span class="hl-2">script</span><span class="hl-1">&gt;</span><br/><span class="hl-7">const</span><span class="hl-6"> {</span><span class="hl-8">Thread</span><span class="hl-6">} </span><span class="hl-3">=</span><span class="hl-6"> </span><span class="hl-9">threads</span><br/><span class="hl-6">    </span><br/><span class="hl-7">async</span><span class="hl-6"> </span><span class="hl-7">function</span><span class="hl-6"> </span><span class="hl-10">doWork</span><span class="hl-6">() {</span><br/><span class="hl-6">    </span><span class="hl-0">// Create a thread that will automatically close</span><br/><span class="hl-6">    </span><span class="hl-7">const</span><span class="hl-6"> </span><span class="hl-8">thread</span><span class="hl-6"> </span><span class="hl-3">=</span><span class="hl-6"> </span><span class="hl-11">await</span><span class="hl-6"> </span><span class="hl-9">Thread</span><span class="hl-6">.</span><span class="hl-10">spawn</span><span class="hl-6">(</span><span class="hl-12">&#39;worker.js&#39;</span><span class="hl-6">, {</span><span class="hl-9">closeWhenIdle:</span><span class="hl-6"> </span><span class="hl-13">100</span><span class="hl-6">})</span><br/><span class="hl-6">    </span><span class="hl-9">document</span><span class="hl-6">.</span><span class="hl-10">getElementById</span><span class="hl-6">(</span><span class="hl-12">&#39;btn&#39;</span><span class="hl-6">).</span><span class="hl-9">disabled</span><span class="hl-6"> </span><span class="hl-3">=</span><span class="hl-6"> </span><span class="hl-7">true</span><br/><span class="hl-6">    </span><span class="hl-7">const</span><span class="hl-6"> </span><span class="hl-8">res</span><span class="hl-6"> </span><span class="hl-3">=</span><span class="hl-6"> </span><span class="hl-11">await</span><span class="hl-6"> </span><span class="hl-9">thread</span><span class="hl-6">.</span><span class="hl-10">sendWork</span><span class="hl-6">({</span><span class="hl-9">action:</span><span class="hl-6"> </span><span class="hl-12">&#39;square&#39;</span><span class="hl-6">, </span><span class="hl-9">value:</span><span class="hl-6"> </span><span class="hl-13">42</span><span class="hl-6">})</span><br/><span class="hl-6">    </span><span class="hl-9">document</span><span class="hl-6">.</span><span class="hl-10">getElementById</span><span class="hl-6">(</span><span class="hl-12">&#39;result&#39;</span><span class="hl-6">).</span><span class="hl-9">innerText</span><span class="hl-6"> </span><span class="hl-3">=</span><span class="hl-6"> </span><span class="hl-9">res</span><br/><span class="hl-6">    </span><span class="hl-9">document</span><span class="hl-6">.</span><span class="hl-10">getElementById</span><span class="hl-6">(</span><span class="hl-12">&#39;btn&#39;</span><span class="hl-6">).</span><span class="hl-9">disabled</span><span class="hl-6"> </span><span class="hl-3">=</span><span class="hl-6"> </span><span class="hl-7">false</span><br/><span class="hl-6">}</span><br/><span class="hl-1">&lt;/</span><span class="hl-2">script</span><span class="hl-1">&gt;</span>
</code><button type="button">Copy</button></pre>

<p>And for the worker thread:</p>
<pre><code class="javascript"><span class="hl-10">importScripts</span><span class="hl-3">(</span><span class="hl-12">&#39;/public/threads.iife.js&#39;</span><span class="hl-3">)</span><br/><br/><span class="hl-10">onwork</span><span class="hl-3"> = ({</span><span class="hl-9">action</span><span class="hl-3">, </span><span class="hl-9">value</span><span class="hl-3">}) </span><span class="hl-7">=&gt;</span><span class="hl-3"> {</span><br/><span class="hl-3">    </span><span class="hl-11">switch</span><span class="hl-3"> (</span><span class="hl-9">action</span><span class="hl-3">) {</span><br/><span class="hl-3">        </span><span class="hl-11">case</span><span class="hl-3"> </span><span class="hl-12">&#39;square&#39;</span><span class="hl-3">: </span><span class="hl-11">return</span><span class="hl-3"> </span><span class="hl-9">value</span><span class="hl-3"> * </span><span class="hl-9">value</span><br/><span class="hl-3">        </span><span class="hl-11">case</span><span class="hl-3"> </span><span class="hl-12">&#39;increment&#39;</span><span class="hl-3">: </span><span class="hl-11">return</span><span class="hl-3"> </span><span class="hl-9">value</span><span class="hl-3"> + </span><span class="hl-13">1</span><br/><span class="hl-3">        </span><span class="hl-11">case</span><span class="hl-3"> </span><span class="hl-12">&#39;cube&#39;</span><span class="hl-3">: </span><span class="hl-11">return</span><span class="hl-3"> </span><span class="hl-9">value</span><span class="hl-3"> * </span><span class="hl-9">value</span><span class="hl-3"> * </span><span class="hl-9">value</span><br/><span class="hl-3">        </span><span class="hl-11">default</span><span class="hl-3">:</span><br/><span class="hl-3">            </span><span class="hl-10">sendError</span><span class="hl-3">(</span><span class="hl-12">`Unknown action: </span><span class="hl-7">${</span><span class="hl-9">action</span><span class="hl-7">}</span><span class="hl-12">`</span><span class="hl-3">)</span><br/><span class="hl-3">    }</span><br/><span class="hl-3">}</span>
</code><button type="button">Copy</button></pre>

<p>This whole process handles creating threads, initializing them with a unique id (and other initial data), creating an object dehydration/hydration framework,
setting up error handling, initializing (optional) tracing, and building a standard messaging protocol.</p>
<p>With this, we now have a way to easily do work in the background without blocking the main thread.</p>
<h2 id="closing-threads" class="tsd-anchor-link">Closing Threads<a href="#closing-threads" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2>
<p>By default, threads don't close automatically. This can cause resource consumption issues if your program repeatedly spawns new threads that never end.
There are several ways to close threads:</p>
<ul>
<li>Provide an idle timeout which will automatically close threads after they have been idle (not received/processed a message) for that many milliseconds. Done via the <code>closeWhenIdle</code> option to <code>Thread.spawn</code>.</li>
<li>Call <code>Thread.close()</code> once you are done with a thread to attempt a graceful shutdown</li>
<li>Call <code>Thread.kill()</code> once you are done to force a shutdown</li>
<li>Call <code>close()</code>/<code>self.close()</code> from inside the thread once it is done</li>
<li>Use a global thread pool to manage threads automatically</li>
</ul>
<pre><code class="html"><span class="hl-0">&lt;!-- index.html --&gt;</span><br/><span class="hl-1">&lt;</span><span class="hl-2">button</span><span class="hl-3"> </span><span class="hl-4">id</span><span class="hl-3">=</span><span class="hl-5">&quot;btn&quot;</span><span class="hl-1">&gt;</span><span class="hl-3">Click Me!</span><span class="hl-1">&lt;/</span><span class="hl-2">button</span><span class="hl-1">&gt;</span><br/><span class="hl-1">&lt;</span><span class="hl-2">div</span><span class="hl-3"> </span><span class="hl-4">id</span><span class="hl-3">=</span><span class="hl-5">&quot;result&quot;</span><span class="hl-1">&gt;&lt;/</span><span class="hl-2">div</span><span class="hl-1">&gt;</span><br/><br/><span class="hl-1">&lt;</span><span class="hl-2">script</span><span class="hl-6"> </span><span class="hl-4">src</span><span class="hl-6">=</span><span class="hl-5">&quot;/public/threads.iife.js&quot;</span><span class="hl-1">&gt;&lt;/</span><span class="hl-2">script</span><span class="hl-1">&gt;</span><br/><span class="hl-1">&lt;</span><span class="hl-2">script</span><span class="hl-1">&gt;</span><br/><span class="hl-6">    </span><span class="hl-7">const</span><span class="hl-6"> {</span><span class="hl-8">Thread</span><span class="hl-6">} </span><span class="hl-3">=</span><span class="hl-6"> </span><span class="hl-9">threads</span><br/><br/><span class="hl-6">    </span><span class="hl-7">async</span><span class="hl-6"> </span><span class="hl-7">function</span><span class="hl-6"> </span><span class="hl-10">doWork</span><span class="hl-6">() {</span><br/><span class="hl-6">        </span><span class="hl-7">const</span><span class="hl-6"> </span><span class="hl-8">thread</span><span class="hl-6"> </span><span class="hl-3">=</span><span class="hl-6"> </span><span class="hl-11">await</span><span class="hl-6"> </span><span class="hl-9">Thread</span><span class="hl-6">.</span><span class="hl-10">spawn</span><span class="hl-6">(</span><span class="hl-12">&#39;worker.js&#39;</span><span class="hl-6">, {</span><span class="hl-9">closeWhenIdle:</span><span class="hl-6"> </span><span class="hl-13">100</span><span class="hl-6">}) </span><span class="hl-0">// auto close</span><br/><span class="hl-6">        </span><span class="hl-9">document</span><span class="hl-6">.</span><span class="hl-10">getElementById</span><span class="hl-6">(</span><span class="hl-12">&#39;btn&#39;</span><span class="hl-6">).</span><span class="hl-9">disabled</span><span class="hl-6"> </span><span class="hl-3">=</span><span class="hl-6"> </span><span class="hl-7">true</span><br/><span class="hl-6">        </span><span class="hl-7">const</span><span class="hl-6"> </span><span class="hl-8">res</span><span class="hl-6"> </span><span class="hl-3">=</span><span class="hl-6"> </span><span class="hl-11">await</span><span class="hl-6"> </span><span class="hl-9">thread</span><span class="hl-6">.</span><span class="hl-10">sendWork</span><span class="hl-6">({</span><span class="hl-9">action:</span><span class="hl-6"> </span><span class="hl-12">&#39;square&#39;</span><span class="hl-6">, </span><span class="hl-9">value:</span><span class="hl-6"> </span><span class="hl-13">42</span><span class="hl-6">})</span><br/><span class="hl-6">        </span><span class="hl-9">document</span><span class="hl-6">.</span><span class="hl-10">getElementById</span><span class="hl-6">(</span><span class="hl-12">&#39;result&#39;</span><span class="hl-6">).</span><span class="hl-9">innerText</span><span class="hl-6"> </span><span class="hl-3">=</span><span class="hl-6"> </span><span class="hl-9">res</span><br/><span class="hl-6">        </span><span class="hl-9">document</span><span class="hl-6">.</span><span class="hl-10">getElementById</span><span class="hl-6">(</span><span class="hl-12">&#39;btn&#39;</span><span class="hl-6">).</span><span class="hl-9">disabled</span><span class="hl-6"> </span><span class="hl-3">=</span><span class="hl-6"> </span><span class="hl-7">false</span><br/><span class="hl-6">    }</span><br/><span class="hl-1">&lt;/</span><span class="hl-2">script</span><span class="hl-1">&gt;</span>
</code><button type="button">Copy</button></pre>

<h2 id="thread-pool-usage" class="tsd-anchor-link">Thread Pool Usage<a href="#thread-pool-usage" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2>
<p>At times, we may want a maximum limit on how many threads we can have. We also may want to scale down the number of threads automatically if they're idle.
To achieve this, simply use a <code>ThreadPool</code> which handles orchestrating threads, scaling up, and scaling down automatically.</p>
<blockquote>
<p>Note: due to the asynchronous nature of spawning threads, creating a thread pool is also asynchronous</p>
</blockquote>
<p>Here is an example:</p>
<pre><code class="html"><span class="hl-0">&lt;!-- index.html --&gt;</span><br/><span class="hl-1">&lt;</span><span class="hl-2">button</span><span class="hl-3"> </span><span class="hl-4">id</span><span class="hl-3">=</span><span class="hl-5">&quot;btn&quot;</span><span class="hl-1">&gt;</span><span class="hl-3">Click Me!</span><span class="hl-1">&lt;/</span><span class="hl-2">button</span><span class="hl-1">&gt;</span><br/><span class="hl-1">&lt;</span><span class="hl-2">div</span><span class="hl-3"> </span><span class="hl-4">id</span><span class="hl-3">=</span><span class="hl-5">&quot;result&quot;</span><span class="hl-1">&gt;&lt;/</span><span class="hl-2">div</span><span class="hl-1">&gt;</span><br/><br/><span class="hl-1">&lt;</span><span class="hl-2">script</span><span class="hl-6"> </span><span class="hl-4">src</span><span class="hl-6">=</span><span class="hl-5">&quot;/public/threads.iife.js&quot;</span><span class="hl-1">&gt;&lt;/</span><span class="hl-2">script</span><span class="hl-1">&gt;</span><br/><span class="hl-1">&lt;</span><span class="hl-2">script</span><span class="hl-1">&gt;</span><br/><span class="hl-6">    </span><span class="hl-7">const</span><span class="hl-6"> {</span><span class="hl-8">ThreadPool</span><span class="hl-6">} </span><span class="hl-3">=</span><span class="hl-6"> </span><span class="hl-9">threads</span><br/><span class="hl-6">    </span><span class="hl-7">const</span><span class="hl-6"> </span><span class="hl-8">pool</span><span class="hl-6"> </span><span class="hl-3">=</span><span class="hl-6"> </span><span class="hl-9">ThreadPool</span><span class="hl-6">.</span><span class="hl-10">spawn</span><span class="hl-6">(</span><span class="hl-12">&#39;worker.js&#39;</span><span class="hl-6">, {</span><span class="hl-9">minThreads:</span><span class="hl-6"> </span><span class="hl-13">2</span><span class="hl-6">, </span><span class="hl-9">maxThreads:</span><span class="hl-6"> </span><span class="hl-13">10</span><span class="hl-6">, </span><span class="hl-9">closeThreadWhenIdle:</span><span class="hl-6"> </span><span class="hl-13">200</span><span class="hl-6">})</span><br/><br/><span class="hl-6">    </span><span class="hl-7">async</span><span class="hl-6"> </span><span class="hl-7">function</span><span class="hl-6"> </span><span class="hl-10">doWork</span><span class="hl-6">() {</span><br/><span class="hl-6">        </span><span class="hl-0">// Get the pool</span><br/><span class="hl-6">        </span><span class="hl-7">const</span><span class="hl-6"> </span><span class="hl-8">p</span><span class="hl-6"> </span><span class="hl-3">=</span><span class="hl-6"> </span><span class="hl-11">await</span><span class="hl-6"> </span><span class="hl-9">pool</span><br/><span class="hl-6">        </span><span class="hl-9">document</span><span class="hl-6">.</span><span class="hl-10">getElementById</span><span class="hl-6">(</span><span class="hl-12">&#39;btn&#39;</span><span class="hl-6">).</span><span class="hl-9">disabled</span><span class="hl-6"> </span><span class="hl-3">=</span><span class="hl-6"> </span><span class="hl-7">true</span><br/><span class="hl-6">        </span><span class="hl-7">const</span><span class="hl-6"> </span><span class="hl-8">res</span><span class="hl-6"> </span><span class="hl-3">=</span><span class="hl-6"> </span><span class="hl-11">await</span><span class="hl-6"> </span><span class="hl-9">p</span><span class="hl-6">.</span><span class="hl-10">sendWork</span><span class="hl-6">({</span><span class="hl-9">action:</span><span class="hl-6"> </span><span class="hl-12">&#39;square&#39;</span><span class="hl-6">, </span><span class="hl-9">value:</span><span class="hl-6"> </span><span class="hl-13">42</span><span class="hl-6">})</span><br/><span class="hl-6">        </span><span class="hl-9">document</span><span class="hl-6">.</span><span class="hl-10">getElementById</span><span class="hl-6">(</span><span class="hl-12">&#39;result&#39;</span><span class="hl-6">).</span><span class="hl-9">innerText</span><span class="hl-6"> </span><span class="hl-3">=</span><span class="hl-6"> </span><span class="hl-9">res</span><br/><span class="hl-6">        </span><span class="hl-9">document</span><span class="hl-6">.</span><span class="hl-10">getElementById</span><span class="hl-6">(</span><span class="hl-12">&#39;btn&#39;</span><span class="hl-6">).</span><span class="hl-9">disabled</span><span class="hl-6"> </span><span class="hl-3">=</span><span class="hl-6"> </span><span class="hl-7">false</span><br/><span class="hl-6">    }</span><br/><span class="hl-1">&lt;/</span><span class="hl-2">script</span><span class="hl-1">&gt;</span>
</code><button type="button">Copy</button></pre>

<blockquote>
<p>Note: The worker code did not change from the general usage example. Workers don't care if they're in a pool or not. This makes it trivial to switch between the two</p>
</blockquote>
<h2 id="sending-classes" class="tsd-anchor-link">Sending classes<a href="#sending-classes" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2>
<p>Sometimes you want to share a class. Unfortunately, JavaScript doesn't let sending full classes or functions through message passing.
So, instead we need to &quot;dehydrate&quot; (or serialize) the object on one end, and then &quot;hydrate&quot; (or deserialize) on the other end.
Fortunately, this is built-in to the threads library! And, it happens automatically on every <code>postMessage</code> and <code>onmessage</code> on both ends!
It even works when we do <code>initData</code> on the spawn method.</p>
<blockquote>
<p>The reason it is turned on by default is for shared memory data structures (e.g. Mutex) to work</p>
</blockquote>
<p>To pass classes, we first need to register a dehydrate and hydrate method for the class. We'll also need to pick a unique key for the dehydrated state.</p>
<p>There are two ways to create dehydrate/hydrate methods:</p>
<ul>
<li>Create static methods on your TypeScript classes (or the JavaScript equivalent)</li>
<li>Create an &quot;isa&quot; method, &quot;hydrate&quot; method, and &quot;dehydrate&quot; method</li>
</ul>
<p>Once we have those methods, we call <code>registerDeHydration</code> to register it.</p>
<p>Example for static methods class:</p>
<pre><code class="typescript"><span class="hl-11">import</span><span class="hl-3"> {</span><span class="hl-9">registerDeHydration</span><span class="hl-3">} </span><span class="hl-11">from</span><span class="hl-3"> </span><span class="hl-12">&quot;@matttolman/threads&quot;</span><span class="hl-3">;</span><br/><br/><span class="hl-7">interface</span><span class="hl-3"> </span><span class="hl-14">DehydratedPerson</span><span class="hl-3"> {</span><br/><span class="hl-3">    </span><span class="hl-9">name</span><span class="hl-3">: </span><span class="hl-14">string</span><span class="hl-3">,</span><br/><span class="hl-3">    </span><span class="hl-9">age</span><span class="hl-3">: </span><span class="hl-14">number</span><span class="hl-3">,</span><br/><span class="hl-3">}</span><br/><br/><span class="hl-7">class</span><span class="hl-3"> </span><span class="hl-14">Person</span><span class="hl-3"> {</span><br/><span class="hl-3">    </span><span class="hl-7">private</span><span class="hl-3"> </span><span class="hl-9">name</span><span class="hl-3">: </span><span class="hl-14">string</span><br/><span class="hl-3">    </span><span class="hl-7">private</span><span class="hl-3"> </span><span class="hl-9">age</span><span class="hl-3">: </span><span class="hl-14">number</span><br/><br/><span class="hl-3">    </span><span class="hl-7">constructor</span><span class="hl-3">(</span><span class="hl-9">name</span><span class="hl-3">: </span><span class="hl-14">string</span><span class="hl-3">, </span><span class="hl-9">age</span><span class="hl-3">: </span><span class="hl-14">number</span><span class="hl-3">) {</span><br/><span class="hl-3">        </span><span class="hl-7">this</span><span class="hl-3">.</span><span class="hl-9">name</span><span class="hl-3"> = </span><span class="hl-9">name</span><br/><span class="hl-3">        </span><span class="hl-7">this</span><span class="hl-3">.</span><span class="hl-9">age</span><span class="hl-3"> = </span><span class="hl-9">age</span><br/><span class="hl-3">    }</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-7">public</span><span class="hl-3"> </span><span class="hl-7">static</span><span class="hl-3"> </span><span class="hl-10">dehydrate</span><span class="hl-3">(</span><span class="hl-9">person</span><span class="hl-3">: </span><span class="hl-14">Person</span><span class="hl-3">): </span><span class="hl-14">DehydratedPerson</span><span class="hl-3"> {</span><br/><span class="hl-3">        </span><span class="hl-11">return</span><span class="hl-3"> {</span><br/><span class="hl-3">            </span><span class="hl-9">name:</span><span class="hl-3"> </span><span class="hl-9">person</span><span class="hl-3">.</span><span class="hl-9">name</span><span class="hl-3">,</span><br/><span class="hl-3">            </span><span class="hl-9">age:</span><span class="hl-3"> </span><span class="hl-9">person</span><span class="hl-3">.</span><span class="hl-9">age</span><br/><span class="hl-3">        }</span><br/><span class="hl-3">    }</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-7">public</span><span class="hl-3"> </span><span class="hl-7">static</span><span class="hl-3"> </span><span class="hl-10">hydrate</span><span class="hl-3">(</span><span class="hl-9">person</span><span class="hl-3">: </span><span class="hl-14">DehydratedPersion</span><span class="hl-3">) {</span><br/><span class="hl-3">        </span><span class="hl-11">return</span><span class="hl-3"> </span><span class="hl-7">new</span><span class="hl-3"> </span><span class="hl-10">Person</span><span class="hl-3">(</span><span class="hl-9">person</span><span class="hl-3">.</span><span class="hl-9">name</span><span class="hl-3">, </span><span class="hl-9">person</span><span class="hl-3">.</span><span class="hl-9">age</span><span class="hl-3">)</span><br/><span class="hl-3">    }</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-7">public</span><span class="hl-3"> </span><span class="hl-10">isAdultUs</span><span class="hl-3">(): </span><span class="hl-14">boolean</span><span class="hl-3"> {</span><br/><span class="hl-3">        </span><span class="hl-11">return</span><span class="hl-3"> </span><span class="hl-7">this</span><span class="hl-3">.</span><span class="hl-9">age</span><span class="hl-3"> &gt;= </span><span class="hl-13">18</span><br/><span class="hl-3">    }</span><br/><span class="hl-3">}</span><br/><br/><span class="hl-10">registerDeHydration</span><span class="hl-3">({</span><span class="hl-9">key:</span><span class="hl-3"> </span><span class="hl-12">&#39;Person&#39;</span><span class="hl-3">, </span><span class="hl-9">type:</span><span class="hl-3"> </span><span class="hl-9">Person</span><span class="hl-3">})</span>
</code><button type="button">Copy</button></pre>

<p>Example for independent functions class:</p>
<pre><code class="typescript"><span class="hl-11">import</span><span class="hl-3"> {</span><span class="hl-9">registerDeHydration</span><span class="hl-3">} </span><span class="hl-11">from</span><span class="hl-3"> </span><span class="hl-12">&quot;@matttolman/threads&quot;</span><span class="hl-3">;</span><br/><br/><span class="hl-7">interface</span><span class="hl-3"> </span><span class="hl-14">DehydratedPerson</span><span class="hl-3"> {</span><br/><span class="hl-3">    </span><span class="hl-9">name</span><span class="hl-3">: </span><span class="hl-14">string</span><span class="hl-3">,</span><br/><span class="hl-3">    </span><span class="hl-9">age</span><span class="hl-3">: </span><span class="hl-14">number</span><span class="hl-3">,</span><br/><span class="hl-3">}</span><br/><br/><span class="hl-7">class</span><span class="hl-3"> </span><span class="hl-14">Person</span><span class="hl-3"> {</span><br/><span class="hl-3">    </span><span class="hl-7">private</span><span class="hl-3"> </span><span class="hl-9">name</span><span class="hl-3">: </span><span class="hl-14">string</span><br/><span class="hl-3">    </span><span class="hl-7">private</span><span class="hl-3"> </span><span class="hl-9">age</span><span class="hl-3">: </span><span class="hl-14">number</span><br/><br/><span class="hl-3">    </span><span class="hl-7">constructor</span><span class="hl-3">(</span><span class="hl-9">name</span><span class="hl-3">: </span><span class="hl-14">string</span><span class="hl-3">, </span><span class="hl-9">age</span><span class="hl-3">: </span><span class="hl-14">number</span><span class="hl-3">) {</span><br/><span class="hl-3">        </span><span class="hl-7">this</span><span class="hl-3">.</span><span class="hl-9">name</span><span class="hl-3"> = </span><span class="hl-9">name</span><br/><span class="hl-3">        </span><span class="hl-7">this</span><span class="hl-3">.</span><span class="hl-9">age</span><span class="hl-3"> = </span><span class="hl-9">age</span><br/><span class="hl-3">    }</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-7">public</span><span class="hl-3"> </span><span class="hl-10">isAdultUs</span><span class="hl-3">(): </span><span class="hl-14">boolean</span><span class="hl-3"> {</span><br/><span class="hl-3">        </span><span class="hl-11">return</span><span class="hl-3"> </span><span class="hl-7">this</span><span class="hl-3">.</span><span class="hl-9">age</span><span class="hl-3"> &gt;= </span><span class="hl-13">18</span><br/><span class="hl-3">    }</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-7">public</span><span class="hl-3"> </span><span class="hl-10">getName</span><span class="hl-3">(): </span><span class="hl-14">string</span><span class="hl-3"> { </span><span class="hl-11">return</span><span class="hl-3"> </span><span class="hl-7">this</span><span class="hl-3">.</span><span class="hl-9">name</span><span class="hl-3"> }</span><br/><span class="hl-3">    </span><span class="hl-7">public</span><span class="hl-3"> </span><span class="hl-10">getAge</span><span class="hl-3">(): </span><span class="hl-14">string</span><span class="hl-3"> { </span><span class="hl-11">return</span><span class="hl-3"> </span><span class="hl-7">this</span><span class="hl-3">.</span><span class="hl-9">age</span><span class="hl-3"> }</span><br/><span class="hl-3">}</span><br/><br/><span class="hl-7">function</span><span class="hl-3"> </span><span class="hl-10">isaPerson</span><span class="hl-3">(</span><span class="hl-9">obj</span><span class="hl-3">: </span><span class="hl-14">any</span><span class="hl-3">) {</span><br/><span class="hl-3">    </span><span class="hl-11">return</span><span class="hl-3"> </span><span class="hl-9">obj</span><span class="hl-3"> </span><span class="hl-7">instanceof</span><span class="hl-3"> </span><span class="hl-14">Person</span><br/><span class="hl-3">}</span><br/><br/><span class="hl-7">function</span><span class="hl-3"> </span><span class="hl-10">dehydratePerson</span><span class="hl-3">(</span><span class="hl-9">obj</span><span class="hl-3">: </span><span class="hl-14">Person</span><span class="hl-3">): </span><span class="hl-14">DehydratedPerson</span><span class="hl-3"> {</span><br/><span class="hl-3">    </span><span class="hl-11">return</span><span class="hl-3"> { </span><span class="hl-9">name:</span><span class="hl-3"> </span><span class="hl-9">obj</span><span class="hl-3">.</span><span class="hl-10">getName</span><span class="hl-3">(), </span><span class="hl-9">age:</span><span class="hl-3"> </span><span class="hl-9">obj</span><span class="hl-3">.</span><span class="hl-10">getAge</span><span class="hl-3">() }</span><br/><span class="hl-3">}</span><br/><br/><span class="hl-7">function</span><span class="hl-3"> </span><span class="hl-10">hydratePerson</span><span class="hl-3">(</span><span class="hl-9">obj</span><span class="hl-3">: </span><span class="hl-14">DehydratedPerson</span><span class="hl-3">): </span><span class="hl-14">Person</span><span class="hl-3"> {</span><br/><span class="hl-3">    </span><span class="hl-11">return</span><span class="hl-3"> </span><span class="hl-7">new</span><span class="hl-3"> </span><span class="hl-10">Person</span><span class="hl-3">(</span><span class="hl-9">obj</span><span class="hl-3">.</span><span class="hl-9">name</span><span class="hl-3">, </span><span class="hl-9">obj</span><span class="hl-3">.</span><span class="hl-9">age</span><span class="hl-3">)</span><br/><span class="hl-3">}</span><br/><br/><span class="hl-10">registerDeHydration</span><span class="hl-3">({</span><span class="hl-9">key:</span><span class="hl-3"> </span><span class="hl-12">&#39;Person&#39;</span><span class="hl-3">, </span><span class="hl-9">isa:</span><span class="hl-3"> </span><span class="hl-9">isaPerson</span><span class="hl-3">, </span><span class="hl-9">hydrate:</span><span class="hl-3"> </span><span class="hl-9">hydratePerson</span><span class="hl-3">, </span><span class="hl-9">dehydrate:</span><span class="hl-3"> </span><span class="hl-9">dehydratePerson</span><span class="hl-3">})</span>
</code><button type="button">Copy</button></pre>

<p>Regardless of which approach you take, the following code would be possible:</p>
<pre><code class="typescript"><span class="hl-0">// main.ts</span><br/><span class="hl-11">import</span><span class="hl-3"> {</span><span class="hl-9">Thread</span><span class="hl-3">} </span><span class="hl-11">from</span><span class="hl-3"> </span><span class="hl-12">&#39;@matttolman/threads&#39;</span><br/><span class="hl-11">import</span><span class="hl-3"> {</span><span class="hl-9">Person</span><span class="hl-3">} </span><span class="hl-11">from</span><span class="hl-3"> </span><span class="hl-12">&#39;./person&#39;</span><br/><br/><span class="hl-7">async</span><span class="hl-3"> </span><span class="hl-7">function</span><span class="hl-3"> </span><span class="hl-10">sendPerson</span><span class="hl-3">() {</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">person</span><span class="hl-3"> = </span><span class="hl-7">new</span><span class="hl-3"> </span><span class="hl-10">Person</span><span class="hl-3">(</span><span class="hl-12">&#39;Bob&#39;</span><span class="hl-3">, </span><span class="hl-13">44</span><span class="hl-3">)</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">thread</span><span class="hl-3"> = </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-9">Thread</span><span class="hl-3">.</span><span class="hl-10">spawn</span><span class="hl-3">(</span><span class="hl-12">&#39;worker.js&#39;</span><span class="hl-3">, {</span><span class="hl-9">initData:</span><span class="hl-3"> </span><span class="hl-9">person</span><span class="hl-3">})</span><br/><span class="hl-3">}</span>
</code><button type="button">Copy</button></pre>

<p>And for the worker</p>
<pre><code class="typescript"><span class="hl-0">// worker.ts</span><br/><span class="hl-11">import</span><span class="hl-3"> </span><span class="hl-12">&#39;@matttolman/threads&#39;</span><br/><span class="hl-11">import</span><span class="hl-3"> {</span><span class="hl-9">Person</span><span class="hl-3">} </span><span class="hl-11">from</span><span class="hl-3"> </span><span class="hl-12">&#39;./person&#39;</span><br/><br/><span class="hl-10">oninit</span><span class="hl-3"> = (</span><span class="hl-9">person</span><span class="hl-3">: </span><span class="hl-14">Person</span><span class="hl-3">) </span><span class="hl-7">=&gt;</span><span class="hl-3"> {</span><br/><span class="hl-3">    </span><span class="hl-9">console</span><span class="hl-3">.</span><span class="hl-10">log</span><span class="hl-3">(</span><span class="hl-12">&#39;Is adult?&#39;</span><span class="hl-3">, </span><span class="hl-9">person</span><span class="hl-3">.</span><span class="hl-10">isAdultUs</span><span class="hl-3">())</span><br/><span class="hl-3">}</span>
</code><button type="button">Copy</button></pre>

<p>And just like that, we &quot;sent&quot; an object!</p>
<p>This technique is heavily used to provide shared memory synchronization primitives (like mutexes).</p>
<p>One thing to note about <code>registerDeHydration</code> is that the most recently registerd dehydrate method will take precedence.
This allows you to register a base class in that file, and then register child classes later on, and the child classes
will use their specific dehydration method while the base class will use it's method.</p>
<h2 id="seeding-the-thread" class="tsd-anchor-link">Seeding the thread<a href="#seeding-the-thread" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2>
<p>At times, we may want to seed a thread with some sort of initial state (e.g. are we in developer mode?). To do this, we simply pass in the option <code>initData</code>
in the spawn options, and we define an <code>oninit</code> handler in our worker thread. This <code>oninit</code> handler can be async or return a promise, in which case
<code>Thread.spawn</code> will wait for it to resolve before it resolves (which is why <code>Thread.spawn</code> is async).</p>
<p>The great thing is that this works for both standalone threads and pooled threads! The pool guarantees every thread is initialized with
it makes is given the same <code>initData</code> in the pool's options (though it only has a shallow copy, so be careful if you change it!).</p>
<blockquote>
<p>Note: For simplicity, in the following examples I won't show imports, requires, or destructuring for the library. All of these examples
will assume importing and destructuring have been done.</p>
</blockquote>
<p>Here's an example:</p>
<pre><code class="javascript"><span class="hl-0">// main.js</span><br/><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">mysecret</span><span class="hl-3"> = </span><span class="hl-12">&#39;super-secret&#39;</span><br/><br/><span class="hl-7">async</span><span class="hl-3"> </span><span class="hl-7">function</span><span class="hl-3"> </span><span class="hl-10">spawn</span><span class="hl-3">() {</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">thread</span><span class="hl-3"> = </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-9">Thread</span><span class="hl-3">.</span><span class="hl-10">spawn</span><span class="hl-3">(</span><span class="hl-12">&#39;worker.js&#39;</span><span class="hl-3">, {</span><span class="hl-9">initData:</span><span class="hl-3"> {</span><span class="hl-9">secret:</span><span class="hl-3"> </span><span class="hl-9">mysecret</span><span class="hl-3">}})</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">pool</span><span class="hl-3"> = </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-9">ThreadPool</span><span class="hl-3">.</span><span class="hl-10">spawn</span><span class="hl-3">(</span><span class="hl-12">&#39;worker.js&#39;</span><span class="hl-3">, {</span><span class="hl-9">initData:</span><span class="hl-3"> {</span><span class="hl-9">secret:</span><span class="hl-3"> </span><span class="hl-9">mysecret</span><span class="hl-3">}})</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-9">console</span><span class="hl-3">.</span><span class="hl-10">log</span><span class="hl-3">(</span><span class="hl-9">thread</span><span class="hl-3">.</span><span class="hl-10">sendWork</span><span class="hl-3">(</span><span class="hl-12">&#39;guess1&#39;</span><span class="hl-3">))</span><br/><span class="hl-3">    </span><span class="hl-9">console</span><span class="hl-3">.</span><span class="hl-10">log</span><span class="hl-3">(</span><span class="hl-9">pool</span><span class="hl-3">.</span><span class="hl-10">sendWork</span><span class="hl-3">(</span><span class="hl-12">&#39;guess2&#39;</span><span class="hl-3">))</span><br/><span class="hl-3">        </span><br/><span class="hl-3">    </span><span class="hl-9">console</span><span class="hl-3">.</span><span class="hl-10">log</span><span class="hl-3">(</span><span class="hl-9">thread</span><span class="hl-3">.</span><span class="hl-10">sendWork</span><span class="hl-3">(</span><span class="hl-12">&#39;super-secret&#39;</span><span class="hl-3">))</span><br/><span class="hl-3">    </span><span class="hl-9">console</span><span class="hl-3">.</span><span class="hl-10">log</span><span class="hl-3">(</span><span class="hl-9">pool</span><span class="hl-3">.</span><span class="hl-10">sendWork</span><span class="hl-3">(</span><span class="hl-12">&#39;super-secret&#39;</span><span class="hl-3">))</span><br/><span class="hl-3">}</span>
</code><button type="button">Copy</button></pre>

<p>In the worker now:</p>
<pre><code class="javascript"><span class="hl-0">// worker.js</span><br/><br/><span class="hl-7">let</span><span class="hl-3"> </span><span class="hl-9">secretWord</span><span class="hl-3"> = </span><span class="hl-7">null</span><br/><br/><span class="hl-10">oninit</span><span class="hl-3"> = ({</span><span class="hl-9">secret</span><span class="hl-3">}) </span><span class="hl-7">=&gt;</span><span class="hl-3"> {</span><br/><span class="hl-3">    </span><span class="hl-9">console</span><span class="hl-3">.</span><span class="hl-10">log</span><span class="hl-3">(</span><span class="hl-12">&#39;Got my secret word!&#39;</span><span class="hl-3">)</span><br/><span class="hl-3">    </span><span class="hl-9">secretWord</span><span class="hl-3"> = </span><span class="hl-9">secret</span><br/><span class="hl-3">}</span><br/><br/><span class="hl-10">onwork</span><span class="hl-3"> = (</span><span class="hl-9">guess</span><span class="hl-3">) </span><span class="hl-7">=&gt;</span><span class="hl-3"> </span><span class="hl-9">guess</span><span class="hl-3"> === </span><span class="hl-9">secretWord</span>
</code><button type="button">Copy</button></pre>

<h2 id="advanced-usage" class="tsd-anchor-link">Advanced Usage<a href="#advanced-usage" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2>
<p>The above examples will cover the most use cases where we're simply spinning some work off in a background thread.
However, in some cases we need more performance or control. For those use cases, this section is for you.</p>
<h3 id="sending-messages-with-no-responses" class="tsd-anchor-link">Sending Messages With No Responses<a href="#sending-messages-with-no-responses" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>So far, whenever we send a message to a background thread, we always wait for a response from that thread.
But, what if we didn't want a response? What if we just wanted to notify the thread, but didn't care if anything happened?</p>
<p>In those cases, we can send an &quot;event&quot; which will then call the thread's <code>onevent</code> handler. Here's an example:</p>
<pre><code class="html"><span class="hl-3">async function notify() {</span><br/><span class="hl-3">    // Create a thread that will automatically close</span><br/><span class="hl-3">    const thread = await Thread.spawn(&#39;worker.js&#39;, {closeWhenIdle: 100})</span><br/><span class="hl-3">    // no return value</span><br/><span class="hl-3">    thread.sendEvent({action: &#39;button_clicked&#39;})</span><br/><span class="hl-3">}</span>
</code><button type="button">Copy</button></pre>

<p>And for the worker thread:</p>
<pre><code class="javascript"><span class="hl-10">onevent</span><span class="hl-3"> = (</span><span class="hl-9">event</span><span class="hl-3">) </span><span class="hl-7">=&gt;</span><span class="hl-3"> {</span><br/><span class="hl-3">    </span><span class="hl-0">// here we get the full Worker event object</span><br/><span class="hl-3">    </span><span class="hl-0">// so our action will actually be at event.data.action and not event.action</span><br/><span class="hl-3">    </span><span class="hl-9">console</span><span class="hl-3">.</span><span class="hl-10">log</span><span class="hl-3">(</span><span class="hl-9">event</span><span class="hl-3">)</span><br/><span class="hl-3">}</span>
</code><button type="button">Copy</button></pre>

<p>One thing to note about the <code>onevent</code> handler is it always gets the full Worker message from the browser.
So any event data that you send will be in <code>event.data</code> and not in <code>event</code>.
It's the framework's <code>onmessage</code> replacement as the framework overrides <code>onmessage</code> to handle dispatching depending
on what the protocol is.</p>
<p>Additionally, <code>sendEvent</code> takes in the options parameter for <code>postMessage</code>, which allows you to have full control.
It's designed-in way to bypass the framework for sending messages to workers - if you so desire.</p>
<blockquote>
<p>Why might you want to bypass the framework? Well, promises work really well for request/response, and work great
in promise-based frameworks. However, if you need a stream of events (think Observables), then that is not provided
in this library. Why? Simply because we're trying to have zero runtime dependencies (i.e. we use TypeScript and bundlers
for development, but the code we ship only uses native browser APIs). If you ever need to use something other than promises,
then this lets you bring in whatever dependencies you want to do that.</p>
</blockquote>
<h3 id="receiving-events-from-the-thread" class="tsd-anchor-link">Receiving events from the thread<a href="#receiving-events-from-the-thread" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>We've sent events to the thread, now let's have the thread send events to us. This forms the foundation needed to have
events sent to us, and lets us setup wrappers for observables, direct DOM manipulation, etc. We could even create our own
protocol and just use the threading library for initialization!</p>
<p>To receive events from threads, all we need to do is register an event handler. There are two ways to do this:</p>
<ul>
<li>Pass it into the options object when we spawn a thread (recommended)</li>
<li>call <code>setOnEvent</code> (discouraged as race conditions can cause some events to be lost)</li>
</ul>
<p>We'll show the recommended way to do this.</p>
<pre><code class="javascript"><span class="hl-0">// main.js</span><br/><span class="hl-7">async</span><span class="hl-3"> </span><span class="hl-7">function</span><span class="hl-3"> </span><span class="hl-10">customThread</span><span class="hl-3">() {</span><br/><span class="hl-3">    </span><span class="hl-0">// our handler will also get a raw worker message</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-10">handler</span><span class="hl-3"> = (</span><span class="hl-9">v</span><span class="hl-3">) </span><span class="hl-7">=&gt;</span><span class="hl-3"> {</span><br/><span class="hl-3">        </span><span class="hl-9">console</span><span class="hl-3">.</span><span class="hl-10">log</span><span class="hl-3">(</span><span class="hl-9">v</span><span class="hl-3">.</span><span class="hl-9">data</span><span class="hl-3">)</span><br/><span class="hl-3">    }</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-0">// spawn our thread</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">thread</span><span class="hl-3"> = </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-9">Thread</span><span class="hl-3">.</span><span class="hl-10">spawn</span><span class="hl-3">(</span><span class="hl-12">&#39;worker.js&#39;</span><span class="hl-3">, {</span><span class="hl-9">initData:</span><span class="hl-3"> </span><span class="hl-13">45</span><span class="hl-3">, </span><span class="hl-9">onEventHandler:</span><span class="hl-3"> </span><span class="hl-9">handler</span><span class="hl-3">, </span><span class="hl-9">closeWhenIdle:</span><span class="hl-3"> </span><span class="hl-13">100</span><span class="hl-3">})</span><br/><span class="hl-3">    </span><span class="hl-9">thread</span><span class="hl-3">.</span><span class="hl-10">sendEvent</span><span class="hl-3">(-</span><span class="hl-13">23</span><span class="hl-3">)</span><br/><span class="hl-3">}</span>
</code><button type="button">Copy</button></pre>

<p>Worker thread:</p>
<pre><code class="javascript"><span class="hl-0">// worker.js</span><br/><span class="hl-10">onevent</span><span class="hl-3"> = (</span><span class="hl-9">event</span><span class="hl-3">) </span><span class="hl-7">=&gt;</span><span class="hl-3"> {</span><br/><span class="hl-3">    </span><span class="hl-0">// this sends a response to our custom handler</span><br/><span class="hl-3">    </span><span class="hl-10">postMessage</span><span class="hl-3">(</span><span class="hl-13">42</span><span class="hl-3">)</span><br/><span class="hl-3">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="transfering-objects-to-workers" class="tsd-anchor-link">Transfering objects to workers<a href="#transfering-objects-to-workers" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>Some objects, like array buffers, are really large and expensive to send across. Web APIs provide a way to &quot;transfer&quot; the underlying data.
We can use this to our advantage and transfer large objects to the worker thread using the <code>transfer</code> method.
To receive transferred objects, the underlying thread will register the <code>ontransfer</code> handler.</p>
<pre><code class="javascript"><span class="hl-0">// main.js</span><br/><span class="hl-7">async</span><span class="hl-3"> </span><span class="hl-7">function</span><span class="hl-3"> </span><span class="hl-10">transferExample</span><span class="hl-3">() {</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">ab</span><span class="hl-3"> = </span><span class="hl-7">new</span><span class="hl-3"> </span><span class="hl-10">ArrayBuffer</span><span class="hl-3">(</span><span class="hl-13">64</span><span class="hl-3">) </span><span class="hl-0">// some &quot;large&quot; array buffer</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">ints</span><span class="hl-3"> = </span><span class="hl-7">new</span><span class="hl-3"> </span><span class="hl-10">Int32Array</span><span class="hl-3">(</span><span class="hl-9">ab</span><span class="hl-3">) </span><span class="hl-0">// our int view over it</span><br/><span class="hl-3">    </span><span class="hl-9">ints</span><span class="hl-3">.</span><span class="hl-10">set</span><span class="hl-3">([</span><span class="hl-13">99</span><span class="hl-3">], </span><span class="hl-13">0</span><span class="hl-3">) </span><span class="hl-0">// set some data</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">thread</span><span class="hl-3"> = </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-9">Thread</span><span class="hl-3">.</span><span class="hl-10">spawn</span><span class="hl-3">(</span><span class="hl-12">&#39;worker.js&#39;</span><span class="hl-3">)</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-0">// Send the int view over and transfer the underlying buffer</span><br/><span class="hl-3">    </span><span class="hl-0">// After this line, the main thread can **never** use it again!</span><br/><span class="hl-3">    </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-9">thread</span><span class="hl-3">.</span><span class="hl-10">transfer</span><span class="hl-3">(</span><span class="hl-9">ints</span><span class="hl-3">, [</span><span class="hl-9">ints</span><span class="hl-3">.</span><span class="hl-9">buffer</span><span class="hl-3">])</span><br/><span class="hl-3">}</span>
</code><button type="button">Copy</button></pre>

<p>And for the worker:</p>
<pre><code class="javascript"><span class="hl-0">// worker.js</span><br/><br/><span class="hl-0">// The transferred data (second param) is just instructions for the browser on how to manipulate memory</span><br/><span class="hl-0">// Onlyl the &quot;message&quot; (first param) is available for the handler</span><br/><span class="hl-10">ontransfer</span><span class="hl-3"> = (</span><span class="hl-9">intView</span><span class="hl-3">) </span><span class="hl-7">=&gt;</span><span class="hl-3"> {</span><br/><span class="hl-3">    </span><span class="hl-9">console</span><span class="hl-3">.</span><span class="hl-10">log</span><span class="hl-3">(</span><span class="hl-9">intView</span><span class="hl-3">.</span><span class="hl-10">at</span><span class="hl-3">(</span><span class="hl-13">0</span><span class="hl-3">))</span><br/><span class="hl-3">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="transferring-objects-back" class="tsd-anchor-link">Transferring objects back<a href="#transferring-objects-back" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>To transfer objects back, use the global <code>self.transfer</code> method from the worker (or just <code>transfer</code> for short).
To receive a transferred object in the main thread, set the <code>onTransferHandler</code> in the spawn method</p>
<pre><code class="javascript"><span class="hl-0">// main.js</span><br/><span class="hl-7">async</span><span class="hl-3"> </span><span class="hl-7">function</span><span class="hl-3"> </span><span class="hl-10">transferExample</span><span class="hl-3">() {</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-10">handler</span><span class="hl-3"> = (</span><span class="hl-9">buff</span><span class="hl-3">) </span><span class="hl-7">=&gt;</span><span class="hl-3"> {</span><br/><span class="hl-3">        </span><span class="hl-9">console</span><span class="hl-3">.</span><span class="hl-10">log</span><span class="hl-3">(</span><span class="hl-9">buff</span><span class="hl-3">.</span><span class="hl-10">at</span><span class="hl-3">(</span><span class="hl-13">0</span><span class="hl-3">))</span><br/><span class="hl-3">    }</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">thread</span><span class="hl-3"> = </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-9">Thread</span><span class="hl-3">.</span><span class="hl-10">spawn</span><span class="hl-3">(</span><span class="hl-12">&#39;worker3.js&#39;</span><span class="hl-3">, {</span><span class="hl-9">initData:</span><span class="hl-13">45</span><span class="hl-3">, </span><span class="hl-9">onTransferHandler:</span><span class="hl-3"> </span><span class="hl-9">handler</span><span class="hl-3">})</span><br/><span class="hl-3">}</span>
</code><button type="button">Copy</button></pre>

<p>And for the worker:</p>
<pre><code class="javascript"><span class="hl-0">// worker.js</span><br/><br/><span class="hl-0">// The transferred data (second param) is just instructions for the browser on how to manipulate memory</span><br/><span class="hl-0">// Onlyl the &quot;message&quot; (first param) is available for the handler</span><br/><span class="hl-10">oninit</span><span class="hl-3"> = (</span><span class="hl-9">intView</span><span class="hl-3">) </span><span class="hl-7">=&gt;</span><span class="hl-3"> {</span><br/><span class="hl-3">    </span><span class="hl-7">let</span><span class="hl-3"> </span><span class="hl-9">resolve</span><br/><span class="hl-3">    </span><span class="hl-7">let</span><span class="hl-3"> </span><span class="hl-9">ints</span><span class="hl-3"> = </span><span class="hl-7">new</span><span class="hl-3"> </span><span class="hl-10">Int32Array</span><span class="hl-3">(</span><span class="hl-7">new</span><span class="hl-3"> </span><span class="hl-10">ArrayBuffer</span><span class="hl-3">(</span><span class="hl-13">64</span><span class="hl-3">))</span><br/><span class="hl-3">    </span><span class="hl-9">ints</span><span class="hl-3">.</span><span class="hl-10">set</span><span class="hl-3">([</span><span class="hl-13">99</span><span class="hl-3">], </span><span class="hl-13">0</span><span class="hl-3">)</span><br/><span class="hl-3">    </span><span class="hl-0">// if a non-array item is passed as the second parameter, it will be wrapped in an array</span><br/><span class="hl-3">    </span><span class="hl-10">transfer</span><span class="hl-3">(</span><span class="hl-9">ints</span><span class="hl-3">, </span><span class="hl-9">ints</span><span class="hl-3">.</span><span class="hl-9">buffer</span><span class="hl-3">)</span><br/><span class="hl-3">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="sharing-data" class="tsd-anchor-link">&quot;Sharing&quot; data<a href="#sharing-data" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>Sometimes after the fact we need to send more data to the thread without getting a computation result, but we also need to know when it is done receiving/processing data.
This is where &quot;sharing&quot; comes in to play. We can simply use the <code>share</code> method to send data to a thread and the <code>onshare</code> method to receive shared data.</p>
<blockquote>
<p>Note: sharing is not available for thread pools as threads will come and go, and the pool tries to keep a &quot;clean&quot; state. Any shared data must be in the <code>initData</code> for a pool.</p>
</blockquote>
<pre><code class="javascript"><span class="hl-0">// main.js</span><br/><br/><span class="hl-7">async</span><span class="hl-3"> </span><span class="hl-7">function</span><span class="hl-3"> </span><span class="hl-10">shareExample</span><span class="hl-3">() {</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">thread</span><span class="hl-3"> = </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-9">Thread</span><span class="hl-3">.</span><span class="hl-10">spawn</span><span class="hl-3">(</span><span class="hl-12">&#39;worker1.js&#39;</span><span class="hl-3">)</span><br/><span class="hl-3">    </span><span class="hl-9">console</span><span class="hl-3">.</span><span class="hl-10">log</span><span class="hl-3">(</span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-9">thread</span><span class="hl-3">.</span><span class="hl-10">sendWork</span><span class="hl-3">(</span><span class="hl-13">10</span><span class="hl-3">))</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-9">thread</span><span class="hl-3">.</span><span class="hl-10">share</span><span class="hl-3">(</span><span class="hl-13">99</span><span class="hl-3">)</span><br/><span class="hl-3">    </span><span class="hl-9">console</span><span class="hl-3">.</span><span class="hl-10">log</span><span class="hl-3">(</span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-9">thread</span><span class="hl-3">.</span><span class="hl-10">sendWork</span><span class="hl-3">(</span><span class="hl-13">10</span><span class="hl-3">))</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-9">thread</span><span class="hl-3">.</span><span class="hl-10">share</span><span class="hl-3">(-</span><span class="hl-13">45</span><span class="hl-3">)</span><br/><span class="hl-3">    </span><span class="hl-9">console</span><span class="hl-3">.</span><span class="hl-10">log</span><span class="hl-3">(</span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-9">thread</span><span class="hl-3">.</span><span class="hl-10">sendWork</span><span class="hl-3">(</span><span class="hl-13">10</span><span class="hl-3">))</span><br/><span class="hl-3">}</span>
</code><button type="button">Copy</button></pre>

<p>And the worker side:</p>
<pre><code class="javascript"><span class="hl-0">// worker.js</span><br/><br/><span class="hl-7">let</span><span class="hl-3"> </span><span class="hl-9">a</span><span class="hl-3"> = </span><span class="hl-13">0</span><br/><br/><span class="hl-10">onshare</span><span class="hl-3"> = (</span><span class="hl-9">newA</span><span class="hl-3">) </span><span class="hl-7">=&gt;</span><span class="hl-3"> </span><span class="hl-9">a</span><span class="hl-3"> = </span><span class="hl-9">newA</span><br/><br/><span class="hl-10">onWork</span><span class="hl-3"> = </span><span class="hl-9">b</span><span class="hl-3"> </span><span class="hl-7">=&gt;</span><span class="hl-3"> </span><span class="hl-9">a</span><span class="hl-3"> + </span><span class="hl-9">b</span><br/>
</code><button type="button">Copy</button></pre>

<p>Sharing is primarily meant for when we have to share shared memory-based resources (like Mutexes) - hence the name &quot;share&quot;.</p>
<h2 id="shared-memory" class="tsd-anchor-link">Shared Memory<a href="#shared-memory" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2>
<blockquote>
<p><strong>IMPORTANT!</strong> Before you can use anything in this section, you MUST be in a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer#security_requirements">secure context and cross-origin isolated</a>!</p>
</blockquote>
<p>Simply doing message passing isn't all that we can do with threads. We can also share memory!</p>
<p>This is where the <code>share</code> and <code>initData</code> aspects of the above sections really shine. We can share our data once,
and then constantly manipulate it!</p>
<blockquote>
<p>Note: the async shared memory methods require <code>Atomics.waitAsync</code> support in your browser, which requires very up-to-date browsers (Safari and Firefox got support end of 2025).</p>
</blockquote>
<p>Here is an example of what this could look like:</p>
<pre><code class="javascript"><span class="hl-0">// main.js</span><br/><span class="hl-7">const</span><span class="hl-3"> {</span><span class="hl-8">WaitGroup</span><span class="hl-3">, </span><span class="hl-8">Mutex</span><span class="hl-3">, </span><span class="hl-8">Thread</span><span class="hl-3">} = </span><span class="hl-9">threads</span><br/><span class="hl-7">async</span><span class="hl-3"> </span><span class="hl-7">function</span><span class="hl-3"> </span><span class="hl-10">sharedMemExample</span><span class="hl-3">() {</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">wg</span><span class="hl-3"> = </span><span class="hl-9">WaitGroup</span><span class="hl-3">.</span><span class="hl-10">make</span><span class="hl-3">()</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">mem</span><span class="hl-3"> = </span><span class="hl-7">new</span><span class="hl-3"> </span><span class="hl-10">Int32Array</span><span class="hl-3">(</span><span class="hl-7">new</span><span class="hl-3"> </span><span class="hl-10">SharedArrayBuffer</span><span class="hl-3">(</span><span class="hl-13">64</span><span class="hl-3">))</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">mux</span><span class="hl-3"> = </span><span class="hl-9">Mutex</span><span class="hl-3">.</span><span class="hl-10">make</span><span class="hl-3">()</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">thread1</span><span class="hl-3"> = </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-9">Thread</span><span class="hl-3">.</span><span class="hl-10">spawn</span><span class="hl-3">(</span><span class="hl-12">&#39;wait_group.js&#39;</span><span class="hl-3">, {</span><span class="hl-9">initData:</span><span class="hl-3"> {</span><span class="hl-9">wg</span><span class="hl-3">, </span><span class="hl-9">mem</span><span class="hl-3">, </span><span class="hl-9">mux</span><span class="hl-3">}})</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">thread2</span><span class="hl-3"> = </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-9">Thread</span><span class="hl-3">.</span><span class="hl-10">spawn</span><span class="hl-3">(</span><span class="hl-12">&#39;wait_group.js&#39;</span><span class="hl-3">, {</span><span class="hl-9">initData:</span><span class="hl-3"> {</span><span class="hl-9">wg</span><span class="hl-3">, </span><span class="hl-9">mem</span><span class="hl-3">, </span><span class="hl-9">mux</span><span class="hl-3">}})</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-9">wg</span><span class="hl-3">.</span><span class="hl-10">add</span><span class="hl-3">(</span><span class="hl-13">1</span><span class="hl-3">)</span><br/><span class="hl-3">    </span><span class="hl-9">thread1</span><span class="hl-3">.</span><span class="hl-10">sendEvent</span><span class="hl-3">(</span><span class="hl-12">&#39;work&#39;</span><span class="hl-3">)</span><br/><span class="hl-3">    </span><span class="hl-9">wg</span><span class="hl-3">.</span><span class="hl-10">add</span><span class="hl-3">(</span><span class="hl-13">1</span><span class="hl-3">)</span><br/><span class="hl-3">    </span><span class="hl-9">thread2</span><span class="hl-3">.</span><span class="hl-10">sendEvent</span><span class="hl-3">(</span><span class="hl-12">&#39;work&#39;</span><span class="hl-3">)</span><br/><span class="hl-3">    </span><span class="hl-9">wg</span><span class="hl-3">.</span><span class="hl-10">add</span><span class="hl-3">(</span><span class="hl-13">1</span><span class="hl-3">)</span><br/><span class="hl-3">    </span><span class="hl-9">thread1</span><span class="hl-3">.</span><span class="hl-10">sendEvent</span><span class="hl-3">(</span><span class="hl-12">&#39;work&#39;</span><span class="hl-3">)</span><br/><span class="hl-3">    </span><span class="hl-9">wg</span><span class="hl-3">.</span><span class="hl-10">add</span><span class="hl-3">(</span><span class="hl-13">1</span><span class="hl-3">)</span><br/><span class="hl-3">    </span><span class="hl-9">thread2</span><span class="hl-3">.</span><span class="hl-10">sendEvent</span><span class="hl-3">(</span><span class="hl-12">&#39;work&#39;</span><span class="hl-3">)</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-0">// Only place to wait for all work to be done</span><br/><span class="hl-3">    </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-9">wg</span><span class="hl-3">.</span><span class="hl-10">waitAsync</span><span class="hl-3">()</span><br/><span class="hl-3">    </span><span class="hl-9">console</span><span class="hl-3">.</span><span class="hl-10">log</span><span class="hl-3">(</span><span class="hl-9">mem</span><span class="hl-3">.</span><span class="hl-10">at</span><span class="hl-3">(</span><span class="hl-13">0</span><span class="hl-3">))</span><br/><span class="hl-3">}</span>
</code><button type="button">Copy</button></pre>

<p>And the worker:</p>
<pre><code class="javascript"><span class="hl-7">let</span><span class="hl-3"> </span><span class="hl-9">waitGroup</span><span class="hl-3">, </span><span class="hl-9">memory</span><span class="hl-3">, </span><span class="hl-9">mutex</span><br/><span class="hl-10">oninit</span><span class="hl-3"> = ({</span><span class="hl-9">wg</span><span class="hl-3">, </span><span class="hl-9">mem</span><span class="hl-3">, </span><span class="hl-9">mux</span><span class="hl-3">}) </span><span class="hl-7">=&gt;</span><span class="hl-3"> {</span><br/><span class="hl-3">    </span><span class="hl-9">waitGroup</span><span class="hl-3"> = </span><span class="hl-9">wg</span><br/><span class="hl-3">    </span><span class="hl-9">memory</span><span class="hl-3"> = </span><span class="hl-9">mem</span><br/><span class="hl-3">    </span><span class="hl-9">mutex</span><span class="hl-3"> = </span><span class="hl-9">mux</span><br/><span class="hl-3">}</span><br/><br/><span class="hl-10">onevent</span><span class="hl-3"> = () </span><span class="hl-7">=&gt;</span><span class="hl-3"> {</span><br/><span class="hl-3">    </span><span class="hl-9">mux</span><span class="hl-3">.</span><span class="hl-10">lock</span><span class="hl-3">()</span><br/><span class="hl-3">    </span><span class="hl-11">try</span><span class="hl-3"> {</span><br/><span class="hl-3">        </span><span class="hl-9">memory</span><span class="hl-3">.</span><span class="hl-10">set</span><span class="hl-3">([</span><span class="hl-9">memory</span><span class="hl-3">.</span><span class="hl-10">at</span><span class="hl-3">(</span><span class="hl-13">0</span><span class="hl-3">) + </span><span class="hl-13">1</span><span class="hl-3">], </span><span class="hl-13">0</span><span class="hl-3">)</span><br/><span class="hl-3">    }</span><br/><span class="hl-3">    </span><span class="hl-11">finally</span><span class="hl-3"> {</span><br/><span class="hl-3">        </span><span class="hl-9">mux</span><span class="hl-3">.</span><span class="hl-10">unlock</span><span class="hl-3">()</span><br/><span class="hl-3">        </span><span class="hl-9">waitGroup</span><span class="hl-3">.</span><span class="hl-10">done</span><span class="hl-3">()</span><br/><span class="hl-3">    }</span><br/><span class="hl-3">}</span>
</code><button type="button">Copy</button></pre>

<p>The goal of shared memory primitives offered by the threads library is to either provide synchronization between threads
(e.g. a <code>Barrier</code> means all threads reach a point, a <code>WaitGroup</code> means all tasks are done, a <code>ConditionVariable</code> means
some condition/state has changed) or to provide safety when accessing shared resources (e.g. a <code>Mutex</code> guarantees only
one thread is accessing something at a time).</p>
<h3 id="address" class="tsd-anchor-link">Address<a href="#address" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>An address is a reference to a range inside a typed array (range = offset + count). All shared memory synchronization primitives use addresses
to track where their data lives inside of memory. Addresses can be specified manually (usually when you have a large buffer and are dividing
it manually), or they can be created automatically through <code>make</code> functions. The <code>make</code> function will generate a new shared array buffer backing
a new typed array. That means the synchronization primitive has it's memory isolated from all other shared memory. This isolation does provide a
lot more safety guarantees, but it also means that memory is more fragmented which could result in some performance loss.</p>
<p>Addresses expose non-atomic methods (e.g. <code>get</code>, <code>set</code>) as well as atomic methods (e.g. <code>atomicAdd</code>, <code>atomicLoad</code>, <code>atomicStore</code>). All of these
methods default to acting on the first element pointed to by the address. For addresses with only one element (which is common), this greatly
simplifies the interface since you can just treat it as a wrapper class to some data. For addresses pointing to an array of elements, these
methods take the array index as the last parameter (zero-based offset). So, to get the value for the 3rd element of an address, you would use
<code>address.get(2)</code> - or for an atomic load it would be <code>address.atomicLoad(2)</code>.</p>
<p>Example:</p>
<pre><code class="javascript"><span class="hl-11">import</span><span class="hl-3"> {</span><span class="hl-9">Address</span><span class="hl-3">} </span><span class="hl-11">from</span><span class="hl-3"> </span><span class="hl-12">&#39;@matttolman/threads&#39;</span><br/><br/><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">buff</span><span class="hl-3"> = </span><span class="hl-7">new</span><span class="hl-3"> </span><span class="hl-10">SharedArrayBuffer</span><span class="hl-3">(</span><span class="hl-13">32</span><span class="hl-3">)</span><br/><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">typedArr</span><span class="hl-3"> = </span><span class="hl-7">new</span><span class="hl-3"> </span><span class="hl-10">Int32Array</span><span class="hl-3">(</span><span class="hl-9">buff</span><span class="hl-3">)</span><br/><br/><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">addr1</span><span class="hl-3"> = </span><span class="hl-7">new</span><span class="hl-3"> </span><span class="hl-10">Address</span><span class="hl-3">(</span><span class="hl-9">typedArr</span><span class="hl-3">, </span><span class="hl-13">0</span><span class="hl-3">, </span><span class="hl-13">1</span><span class="hl-3">) </span><span class="hl-0">// bytes 0-3</span><br/><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">addr2</span><span class="hl-3"> = </span><span class="hl-7">new</span><span class="hl-3"> </span><span class="hl-10">Address</span><span class="hl-3">(</span><span class="hl-9">typedArr</span><span class="hl-3">, </span><span class="hl-13">1</span><span class="hl-3">, </span><span class="hl-13">3</span><span class="hl-3">) </span><span class="hl-0">// bytes 4-15</span><br/><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">addr3</span><span class="hl-3"> = </span><span class="hl-7">new</span><span class="hl-3"> </span><span class="hl-10">Address</span><span class="hl-3">(</span><span class="hl-9">typedArr</span><span class="hl-3">, </span><span class="hl-13">4</span><span class="hl-3">, </span><span class="hl-13">4</span><span class="hl-3">) </span><span class="hl-0">// bytes 16-31</span>
</code><button type="button">Copy</button></pre>

<h3 id="barrier" class="tsd-anchor-link">Barrier<a href="#barrier" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>A barrier blocks until n threads hit the barrier. This allows threads to synchronize position in the code (we know where
all threads are since they're all at the barrier).</p>
<p>Barriers take in a mutex (or an address for where to make a mutex), an address for an array of two 32-bit integers
(<code>new Address(int32Array, offset, 2)</code>), and a number of threads needed. Barriers have the following methods:</p>
<ul>
<li><code>wait</code> - Blocking wait, waits until the rest of the threads arrive at the barrier. Cannot be called from the main thread</li>
<li><code>waitAsync</code> - Asynchronous version of wait. Requires recent versions of browsers</li>
</ul>
<p>Example:</p>
<pre><code class="typescript"><span class="hl-0">// main.ts</span><br/><span class="hl-11">import</span><span class="hl-3"> {</span><span class="hl-9">Barrier</span><span class="hl-3">, </span><span class="hl-9">Thread</span><span class="hl-3">} </span><span class="hl-11">from</span><span class="hl-3"> </span><span class="hl-12">&#39;@matttolman/threads&#39;</span><br/><br/><span class="hl-7">async</span><span class="hl-3"> </span><span class="hl-7">function</span><span class="hl-3"> </span><span class="hl-10">spawn</span><span class="hl-3">() {</span><br/><span class="hl-3">    </span><span class="hl-0">// Make a barrier that requires three threads to hit it before continuing</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">barrier</span><span class="hl-3"> = </span><span class="hl-9">Barrier</span><span class="hl-3">.</span><span class="hl-10">make</span><span class="hl-3">(</span><span class="hl-13">3</span><span class="hl-3">)</span><br/><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">threads</span><span class="hl-3"> = </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-14">Promise</span><span class="hl-3">.</span><span class="hl-10">all</span><span class="hl-3">([</span><br/><span class="hl-3">        </span><span class="hl-9">Thread</span><span class="hl-3">.</span><span class="hl-10">spawn</span><span class="hl-3">(</span><span class="hl-12">&#39;barrier.js&#39;</span><span class="hl-3">, {</span><span class="hl-9">initData:</span><span class="hl-3"> </span><span class="hl-9">barrier</span><span class="hl-3">}),</span><br/><span class="hl-3">        </span><span class="hl-9">Thread</span><span class="hl-3">.</span><span class="hl-10">spawn</span><span class="hl-3">(</span><span class="hl-12">&#39;barrier.js&#39;</span><span class="hl-3">, {</span><span class="hl-9">initData:</span><span class="hl-3"> </span><span class="hl-9">barrier</span><span class="hl-3">}),</span><br/><span class="hl-3">    ])</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-9">barrier</span><span class="hl-3">.</span><span class="hl-10">waitAsync</span><span class="hl-3">()</span><br/><span class="hl-3">}</span><br/><br/><span class="hl-0">// mutex.ts</span><br/><span class="hl-11">import</span><span class="hl-3"> {</span><span class="hl-9">Mutex</span><span class="hl-3">, </span><span class="hl-9">Thread</span><span class="hl-3">} </span><span class="hl-11">from</span><span class="hl-3"> </span><span class="hl-12">&#39;@matttolman/threads&#39;</span><br/><br/><span class="hl-7">let</span><span class="hl-3"> </span><span class="hl-9">mux</span><span class="hl-3">: </span><span class="hl-14">Mutex</span><br/><br/><span class="hl-10">oninit</span><span class="hl-3"> = (</span><span class="hl-9">mutex</span><span class="hl-3">) </span><span class="hl-7">=&gt;</span><span class="hl-3"> {</span><br/><span class="hl-3">    </span><span class="hl-9">mux</span><span class="hl-3"> = </span><span class="hl-9">mutex</span><br/><br/><span class="hl-3">    </span><span class="hl-11">for</span><span class="hl-3"> (</span><span class="hl-7">let</span><span class="hl-3"> </span><span class="hl-9">i</span><span class="hl-3"> = </span><span class="hl-13">0</span><span class="hl-3">; </span><span class="hl-9">i</span><span class="hl-3"> &lt; </span><span class="hl-13">200</span><span class="hl-3">; ++</span><span class="hl-9">i</span><span class="hl-3">) {</span><br/><span class="hl-3">        </span><span class="hl-9">mux</span><span class="hl-3">.</span><span class="hl-10">lock</span><span class="hl-3">()</span><br/><span class="hl-3">        </span><span class="hl-11">try</span><span class="hl-3"> {</span><br/><span class="hl-3">            </span><span class="hl-9">console</span><span class="hl-3">.</span><span class="hl-10">log</span><span class="hl-3">(</span><span class="hl-12">&quot;Got the lock &quot;</span><span class="hl-3"> + </span><span class="hl-9">i</span><span class="hl-3"> + </span><span class="hl-12">&quot; times!&quot;</span><span class="hl-3">)</span><br/><span class="hl-3">        } </span><span class="hl-11">finally</span><span class="hl-3"> {</span><br/><span class="hl-3">            </span><span class="hl-9">mux</span><span class="hl-3">.</span><span class="hl-10">unlock</span><span class="hl-3">()</span><br/><span class="hl-3">        }</span><br/><span class="hl-3">    }</span><br/><span class="hl-3">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="condition-variable" class="tsd-anchor-link">Condition Variable<a href="#condition-variable" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>A condition variable allows a thread that has a mutex lock to yield that lock to other threads until some condition changes.
After that condition changes the thread that made the change can notify the original thread that the condition has changed.
The original locking thread will then wake up, reobtain the lock, and continue.</p>
<p>Because of the &quot;yielding the lock&quot; thing, a Condition Variable must always be paired with a Mutex. That said, a condition
variable does not <em>own</em> a mutex. Instead, it must be passed in whenever a thread waits (but is not needed on notify).
A condition variable has the following methods:</p>
<ul>
<li><code>wait</code> - Blocking wait method. Takes a mutex and unlocks it, then waits for a signal. When the signal is received, it relocks the mutex. Cannot be called from the main thread.</li>
<li><code>waitAsync</code> - Asynchronous version of wait. Must have a recent browser version.</li>
<li><code>notify</code> - Notify one or more threads that the condition has changed</li>
</ul>
<p>Example:</p>
<pre><code class="typescript"><span class="hl-0">// main.ts</span><br/><span class="hl-11">import</span><span class="hl-3"> {</span><span class="hl-9">ConditionVariable</span><span class="hl-3">, </span><span class="hl-9">Mutex</span><span class="hl-3">, </span><span class="hl-9">Thread</span><span class="hl-3">} </span><span class="hl-11">from</span><span class="hl-3"> </span><span class="hl-12">&quot;./src/main&quot;</span><span class="hl-3">;</span><br/><br/><span class="hl-7">async</span><span class="hl-3"> </span><span class="hl-7">function</span><span class="hl-3"> </span><span class="hl-10">cvExample</span><span class="hl-3">() {</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">mux</span><span class="hl-3"> = </span><span class="hl-9">Mutex</span><span class="hl-3">.</span><span class="hl-10">make</span><span class="hl-3">()</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">cv</span><span class="hl-3"> = </span><span class="hl-9">ConditionVariable</span><span class="hl-3">.</span><span class="hl-10">make</span><span class="hl-3">()</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">mem</span><span class="hl-3"> = </span><span class="hl-7">new</span><span class="hl-3"> </span><span class="hl-10">Int32Array</span><span class="hl-3">(</span><span class="hl-7">new</span><span class="hl-3"> </span><span class="hl-10">SharedArrayBuffer</span><span class="hl-3">(</span><span class="hl-13">4</span><span class="hl-3">))</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-9">mux</span><span class="hl-3">.</span><span class="hl-10">lockAsync</span><span class="hl-3">()</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">thread</span><span class="hl-3"> = </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-9">Thread</span><span class="hl-3">.</span><span class="hl-10">spawn</span><span class="hl-3">(</span><span class="hl-12">&#39;cond_var.js&#39;</span><span class="hl-3">, {</span><span class="hl-9">initData:</span><span class="hl-3"> {</span><span class="hl-9">mux</span><span class="hl-3">, </span><span class="hl-9">cv</span><span class="hl-3">, </span><span class="hl-9">mem</span><span class="hl-3">}})</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-0">// wait until our memory changes</span><br/><span class="hl-3">    </span><span class="hl-11">while</span><span class="hl-3"> (</span><span class="hl-9">mem</span><span class="hl-3">.</span><span class="hl-10">at</span><span class="hl-3">(</span><span class="hl-13">0</span><span class="hl-3">) === </span><span class="hl-13">0</span><span class="hl-3">) {</span><br/><span class="hl-3">        </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-9">cv</span><span class="hl-3">.</span><span class="hl-10">waitAsync</span><span class="hl-3">(</span><span class="hl-9">mux</span><span class="hl-3">)</span><br/><span class="hl-3">    }</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-9">console</span><span class="hl-3">.</span><span class="hl-10">log</span><span class="hl-3">(</span><span class="hl-9">mem</span><span class="hl-3">.</span><span class="hl-10">at</span><span class="hl-3">(</span><span class="hl-13">0</span><span class="hl-3">))</span><br/><span class="hl-3">}</span><br/><br/><span class="hl-0">// cond_var.ts</span><br/><span class="hl-11">import</span><span class="hl-3"> {</span><span class="hl-9">ConditionVariable</span><span class="hl-3">, </span><span class="hl-9">Mutex</span><span class="hl-3">, </span><span class="hl-9">Thread</span><span class="hl-3">} </span><span class="hl-11">from</span><span class="hl-3"> </span><span class="hl-12">&quot;./src/main&quot;</span><span class="hl-3">;</span><br/><br/><span class="hl-10">oninit</span><span class="hl-3"> = </span><span class="hl-7">async</span><span class="hl-3"> ({</span><span class="hl-9">mux</span><span class="hl-3">, </span><span class="hl-9">cv</span><span class="hl-3">, </span><span class="hl-9">mem</span><span class="hl-3">}) </span><span class="hl-7">=&gt;</span><span class="hl-3"> {</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-0">// simulate some work</span><br/><span class="hl-3">    </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-7">new</span><span class="hl-3"> </span><span class="hl-14">Promise</span><span class="hl-3">(</span><span class="hl-9">r</span><span class="hl-3"> </span><span class="hl-7">=&gt;</span><span class="hl-3"> </span><span class="hl-10">setTimeout</span><span class="hl-3">(</span><span class="hl-9">r</span><span class="hl-3">, </span><span class="hl-13">20</span><span class="hl-3">))</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-9">mux</span><span class="hl-3">.</span><span class="hl-10">lock</span><span class="hl-3">()</span><br/><span class="hl-3">    </span><span class="hl-11">try</span><span class="hl-3"> {</span><br/><span class="hl-3">        </span><span class="hl-0">// update our memory</span><br/><span class="hl-3">        </span><span class="hl-9">mem</span><span class="hl-3">.</span><span class="hl-10">set</span><span class="hl-3">([</span><span class="hl-13">42</span><span class="hl-3">], </span><span class="hl-13">0</span><span class="hl-3">)</span><br/><span class="hl-3">        </span><br/><span class="hl-3">        </span><span class="hl-0">// notify our main thread that the memory was changed</span><br/><span class="hl-3">        </span><span class="hl-9">cv</span><span class="hl-3">.</span><span class="hl-10">notify</span><span class="hl-3">()</span><br/><span class="hl-3">    } </span><span class="hl-11">finally</span><span class="hl-3"> {</span><br/><span class="hl-3">        </span><span class="hl-9">mux</span><span class="hl-3">.</span><span class="hl-10">unlock</span><span class="hl-3">()</span><br/><span class="hl-3">    }</span><br/><span class="hl-3">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="mutex" class="tsd-anchor-link">Mutex<a href="#mutex" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>A mutex (mutually exclusive lock) is a type of lock that only allows one thread to have the lock at any point in time.
This is useful if you need to lock some piece of shared memory or other resource shared between threads.</p>
<p>Mutex has a static <code>make</code> method that will allocate a shared array buffer of the right size and create the address for you if you desire.
For manual instantiation, a mutex requires an address to a single 32-bit signed integer (<code>Int32Array</code>; <code>new Address(int32Array, offset, 1)</code>).</p>
<p>A mutex has the following methods:</p>
<ul>
<li><code>lock</code> - Locks the mutex (blocking, not callable from the main/HTML thread)</li>
<li><code>unlock</code> - Unlocks a mutex</li>
<li><code>tryLock</code> - Tries to get the lock without blocking. Returns <code>true</code> if it got the lock, <code>false</code> otherwise</li>
<li><code>hasLock</code> - checks if the current thread has the lock</li>
<li><code>lockAsync</code> - Asynchronous version of lock. Only usable in new browsers (versions after 2025)</li>
</ul>
<blockquote>
<p><strong>Tip:</strong> Always place the <code>unlock</code> call in a finally block so that you always unlock - even if an exception is thrown!</p>
</blockquote>
<p>Example:</p>
<pre><code class="typescript"><span class="hl-0">// main.ts</span><br/><span class="hl-11">import</span><span class="hl-3"> {</span><span class="hl-9">Mutex</span><span class="hl-3">, </span><span class="hl-9">Thread</span><span class="hl-3">} </span><span class="hl-11">from</span><span class="hl-3"> </span><span class="hl-12">&#39;@matttolman/threads&#39;</span><br/><br/><span class="hl-7">async</span><span class="hl-3"> </span><span class="hl-7">function</span><span class="hl-3"> </span><span class="hl-10">spawn</span><span class="hl-3">() {</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">mux</span><span class="hl-3"> = </span><span class="hl-9">Mutex</span><span class="hl-3">.</span><span class="hl-10">make</span><span class="hl-3">()</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">threads</span><span class="hl-3"> = </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-14">Promise</span><span class="hl-3">.</span><span class="hl-10">all</span><span class="hl-3">([</span><br/><span class="hl-3">        </span><span class="hl-9">Thread</span><span class="hl-3">.</span><span class="hl-10">spawn</span><span class="hl-3">(</span><span class="hl-12">&#39;mutex.js&#39;</span><span class="hl-3">, {</span><span class="hl-9">initData:</span><span class="hl-3"> </span><span class="hl-9">mux</span><span class="hl-3">}),</span><br/><span class="hl-3">        </span><span class="hl-9">Thread</span><span class="hl-3">.</span><span class="hl-10">spawn</span><span class="hl-3">(</span><span class="hl-12">&#39;mutex.js&#39;</span><span class="hl-3">, {</span><span class="hl-9">initData:</span><span class="hl-3"> </span><span class="hl-9">mux</span><span class="hl-3">}),</span><br/><span class="hl-3">    ])</span><br/><span class="hl-3">}</span><br/><br/><span class="hl-0">// mutex.ts</span><br/><span class="hl-11">import</span><span class="hl-3"> {</span><span class="hl-9">Mutex</span><span class="hl-3">, </span><span class="hl-9">Thread</span><span class="hl-3">} </span><span class="hl-11">from</span><span class="hl-3"> </span><span class="hl-12">&#39;@matttolman/threads&#39;</span><br/><br/><span class="hl-7">let</span><span class="hl-3"> </span><span class="hl-9">mux</span><span class="hl-3">: </span><span class="hl-14">Mutex</span><br/><br/><span class="hl-10">oninit</span><span class="hl-3"> = (</span><span class="hl-9">mutex</span><span class="hl-3">) </span><span class="hl-7">=&gt;</span><span class="hl-3"> {</span><br/><span class="hl-3">    </span><span class="hl-9">mux</span><span class="hl-3"> = </span><span class="hl-9">mutex</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-11">for</span><span class="hl-3"> (</span><span class="hl-7">let</span><span class="hl-3"> </span><span class="hl-9">i</span><span class="hl-3"> = </span><span class="hl-13">0</span><span class="hl-3">; </span><span class="hl-9">i</span><span class="hl-3"> &lt; </span><span class="hl-13">200</span><span class="hl-3">; ++</span><span class="hl-9">i</span><span class="hl-3">) {</span><br/><span class="hl-3">        </span><span class="hl-9">mux</span><span class="hl-3">.</span><span class="hl-10">lock</span><span class="hl-3">()</span><br/><span class="hl-3">        </span><span class="hl-11">try</span><span class="hl-3"> {</span><br/><span class="hl-3">            </span><span class="hl-9">console</span><span class="hl-3">.</span><span class="hl-10">log</span><span class="hl-3">(</span><span class="hl-12">&quot;Got the lock &quot;</span><span class="hl-3"> + </span><span class="hl-9">i</span><span class="hl-3"> + </span><span class="hl-12">&quot; times!&quot;</span><span class="hl-3">)</span><br/><span class="hl-3">        } </span><span class="hl-11">finally</span><span class="hl-3"> {</span><br/><span class="hl-3">            </span><span class="hl-9">mux</span><span class="hl-3">.</span><span class="hl-10">unlock</span><span class="hl-3">()</span><br/><span class="hl-3">        }</span><br/><span class="hl-3">    }</span><br/><span class="hl-3">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="semaphore" class="tsd-anchor-link">Semaphore<a href="#semaphore" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>A semaphore is a counter-based lock. It lets programs guard a finite number of resources.</p>
<p>Think of it as a library with multiple copies of the same book.
When someone wants to checkout a book, they remove one copy from the library.
When there are no copies left and someone wants to check out the book, they are forced to wait (get put on a &quot;waitlist&quot;).
Once someone else checks in a copy, they can then checkout that copy again.</p>
<p>A semaphore needs one address to a 32 bit integer (<code>new Address(int32Array, offset, 1)</code>) and the maximum number of threads
that can access the semaphore at a time (think maximum number of copies or resources that can be used).
Semaphores have the following methods:</p>
<ul>
<li><code>acquire</code> - Acquires a single resource. Blocks if none are available. Cannot be used from the main thread.</li>
<li><code>acqurieAsync</code> - Asynchronous acquire. Can only be used in newer browsers.</li>
<li><code>release</code> - Releases an acquired resource</li>
<li><code>hasAcquire</code> - Checks if the current thread has acquired at least one resource</li>
</ul>
<p>Example:</p>
<pre><code class="typescript"><span class="hl-0">// main.ts</span><br/><span class="hl-11">import</span><span class="hl-3"> {</span><span class="hl-9">Semaphore</span><span class="hl-3">, </span><span class="hl-9">Thread</span><span class="hl-3">} </span><span class="hl-11">from</span><span class="hl-3"> </span><span class="hl-12">&#39;@matttolman/threads&#39;</span><br/><br/><span class="hl-7">async</span><span class="hl-3"> </span><span class="hl-7">function</span><span class="hl-3"> </span><span class="hl-10">spawn</span><span class="hl-3">() {</span><br/><span class="hl-3">    </span><span class="hl-0">// semaphore with 2 resources</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">sem</span><span class="hl-3"> = </span><span class="hl-9">Semaphore</span><span class="hl-3">.</span><span class="hl-10">make</span><span class="hl-3">(</span><span class="hl-13">2</span><span class="hl-3">)</span><br/><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">threads</span><span class="hl-3"> = </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-14">Promise</span><span class="hl-3">.</span><span class="hl-10">all</span><span class="hl-3">([</span><br/><span class="hl-3">        </span><span class="hl-9">Thread</span><span class="hl-3">.</span><span class="hl-10">spawn</span><span class="hl-3">(</span><span class="hl-12">&#39;sem.js&#39;</span><span class="hl-3">, {</span><span class="hl-9">initData:</span><span class="hl-3"> </span><span class="hl-9">sem</span><span class="hl-3">}),</span><br/><span class="hl-3">        </span><span class="hl-9">Thread</span><span class="hl-3">.</span><span class="hl-10">spawn</span><span class="hl-3">(</span><span class="hl-12">&#39;sem.js&#39;</span><span class="hl-3">, {</span><span class="hl-9">initData:</span><span class="hl-3"> </span><span class="hl-9">sem</span><span class="hl-3">}),</span><br/><span class="hl-3">        </span><span class="hl-9">Thread</span><span class="hl-3">.</span><span class="hl-10">spawn</span><span class="hl-3">(</span><span class="hl-12">&#39;sem.js&#39;</span><span class="hl-3">, {</span><span class="hl-9">initData:</span><span class="hl-3"> </span><span class="hl-9">sem</span><span class="hl-3">}),</span><br/><span class="hl-3">        </span><span class="hl-9">Thread</span><span class="hl-3">.</span><span class="hl-10">spawn</span><span class="hl-3">(</span><span class="hl-12">&#39;sem.js&#39;</span><span class="hl-3">, {</span><span class="hl-9">initData:</span><span class="hl-3"> </span><span class="hl-9">sem</span><span class="hl-3">}),</span><br/><span class="hl-3">    ])</span><br/><span class="hl-3">}</span><br/><br/><span class="hl-0">// mutex.ts</span><br/><span class="hl-11">import</span><span class="hl-3"> {</span><span class="hl-9">Semaphore</span><span class="hl-3">, </span><span class="hl-9">Thread</span><span class="hl-3">} </span><span class="hl-11">from</span><span class="hl-3"> </span><span class="hl-12">&#39;@matttolman/threads&#39;</span><br/><br/><span class="hl-7">let</span><span class="hl-3"> </span><span class="hl-9">sem</span><span class="hl-3">: </span><span class="hl-14">Semaphore</span><br/><br/><span class="hl-10">oninit</span><span class="hl-3"> = </span><span class="hl-7">async</span><span class="hl-3"> (</span><span class="hl-9">semaphore</span><span class="hl-3">) </span><span class="hl-7">=&gt;</span><span class="hl-3"> {</span><br/><span class="hl-3">    </span><span class="hl-9">sem</span><span class="hl-3"> = </span><span class="hl-9">semaphore</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-0">// get the semaphore before we do a network request</span><br/><span class="hl-3">    </span><span class="hl-0">// this lets us throttle how many requests we do at once</span><br/><span class="hl-3">    </span><span class="hl-9">sem</span><span class="hl-3">.</span><span class="hl-10">acquire</span><span class="hl-3">()</span><br/><span class="hl-3">    </span><span class="hl-7">let</span><span class="hl-3"> </span><span class="hl-9">res</span><br/><span class="hl-3">    </span><span class="hl-11">try</span><span class="hl-3"> {</span><br/><span class="hl-3">        </span><span class="hl-9">res</span><span class="hl-3"> = </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-10">fetch</span><span class="hl-3">(</span><span class="hl-12">&#39;http://example.com&#39;</span><span class="hl-3">)</span><br/><span class="hl-3">    } </span><span class="hl-11">finally</span><span class="hl-3"> {</span><br/><span class="hl-3">        </span><span class="hl-9">sem</span><span class="hl-3">.</span><span class="hl-10">release</span><span class="hl-3">()</span><br/><span class="hl-3">    }</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-9">console</span><span class="hl-3">.</span><span class="hl-10">log</span><span class="hl-3">(</span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-9">res</span><span class="hl-3">.</span><span class="hl-10">text</span><span class="hl-3">())</span><br/><span class="hl-3">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="waitgroup" class="tsd-anchor-link">WaitGroup<a href="#waitgroup" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>A WaitGroup allows tracking how many tasks are pending, and then waiting for those tasks to complete. They are styled after Go's <a href="https://pkg.go.dev/sync#WaitGroup">WaitGroup</a>.
When queuing tasks, they are added to the wait group. When completing tasks, they are marked as done.</p>
<p>WaitGroups have the following methods:</p>
<ul>
<li><code>add</code> - Add a task to the counter</li>
<li><code>wait</code> - Wait for the task counter to hit zero. Blocking. Cannot be called from the main thread</li>
<li><code>waitAsync</code> - Asynchronous wait. Can only be used in recent browser versions</li>
<li><code>done</code> - Mark a task as done (decrements task counter)</li>
</ul>
<p>Example:</p>
<pre><code class="typescript"><span class="hl-0">// main.ts</span><br/><span class="hl-11">import</span><span class="hl-3"> {</span><span class="hl-9">WaitGroup</span><span class="hl-3">, </span><span class="hl-9">ThreadPool</span><span class="hl-3">} </span><span class="hl-11">from</span><span class="hl-3"> </span><span class="hl-12">&#39;@matttolman/threads&#39;</span><br/><br/><span class="hl-7">async</span><span class="hl-3"> </span><span class="hl-7">function</span><span class="hl-3"> </span><span class="hl-10">spawn</span><span class="hl-3">() {</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">wg</span><span class="hl-3"> = </span><span class="hl-9">WaitGroup</span><span class="hl-3">.</span><span class="hl-10">make</span><span class="hl-3">()</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">mem</span><span class="hl-3"> = </span><span class="hl-7">new</span><span class="hl-3"> </span><span class="hl-10">Address</span><span class="hl-3">(</span><span class="hl-7">new</span><span class="hl-3"> </span><span class="hl-10">Int32Array</span><span class="hl-3">(</span><span class="hl-7">new</span><span class="hl-3"> </span><span class="hl-10">SharedArrayBuffer</span><span class="hl-3">(</span><span class="hl-13">4</span><span class="hl-3">)))</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-0">// use a pool for load balancing</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">pool</span><span class="hl-3"> = </span><span class="hl-9">ThreadPool</span><span class="hl-3">.</span><span class="hl-10">spawn</span><span class="hl-3">(</span><span class="hl-12">&#39;pool.js&#39;</span><span class="hl-3">, {</span><span class="hl-9">initData:</span><span class="hl-3"> {</span><span class="hl-9">wg</span><span class="hl-3">, </span><span class="hl-9">mem</span><span class="hl-3">}})</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-0">// queue up a bunch of work</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">squareAndSumTasks</span><span class="hl-3"> = [</span><span class="hl-13">1</span><span class="hl-3">, </span><span class="hl-13">2</span><span class="hl-3">, </span><span class="hl-13">3</span><span class="hl-3">, </span><span class="hl-13">4</span><span class="hl-3">, </span><span class="hl-13">5</span><span class="hl-3">, </span><span class="hl-13">6</span><span class="hl-3">, </span><span class="hl-13">7</span><span class="hl-3">, </span><span class="hl-13">8</span><span class="hl-3">, </span><span class="hl-13">9</span><span class="hl-3">, </span><span class="hl-13">10</span><span class="hl-3">, </span><span class="hl-13">11</span><span class="hl-3">, </span><span class="hl-13">12</span><span class="hl-3">, </span><span class="hl-13">13</span><span class="hl-3">, </span><span class="hl-13">14</span><span class="hl-3">, </span><span class="hl-13">15</span><span class="hl-3">, </span><span class="hl-13">16</span><span class="hl-3">, </span><span class="hl-13">17</span><span class="hl-3">]</span><br/><span class="hl-3">    </span><span class="hl-11">for</span><span class="hl-3"> (</span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">t</span><span class="hl-3"> </span><span class="hl-7">of</span><span class="hl-3"> </span><span class="hl-9">squareAndSumTasks</span><span class="hl-3">) {</span><br/><span class="hl-3">        </span><span class="hl-9">wg</span><span class="hl-3">.</span><span class="hl-10">add</span><span class="hl-3">(</span><span class="hl-13">1</span><span class="hl-3">)</span><br/><span class="hl-3">        </span><span class="hl-0">// we don&#39;t care about the intermediate results, just the final result</span><br/><span class="hl-3">        </span><span class="hl-9">pool</span><span class="hl-3">.</span><span class="hl-10">sendWork</span><span class="hl-3">(</span><span class="hl-9">t</span><span class="hl-3">)</span><br/><span class="hl-3">    }</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-0">// only one thing to await</span><br/><span class="hl-3">    </span><span class="hl-11">await</span><span class="hl-3"> </span><span class="hl-9">wg</span><span class="hl-3">.</span><span class="hl-10">waitAsync</span><span class="hl-3">()</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-0">// and we have the result</span><br/><span class="hl-3">    </span><span class="hl-9">console</span><span class="hl-3">.</span><span class="hl-10">log</span><span class="hl-3">(</span><span class="hl-9">mem</span><span class="hl-3">.</span><span class="hl-10">get</span><span class="hl-3">())</span><br/><span class="hl-3">}</span><br/><br/><span class="hl-0">// pool.ts</span><br/><span class="hl-11">import</span><span class="hl-3"> {</span><span class="hl-9">WaitGroup</span><span class="hl-3">, </span><span class="hl-9">Address</span><span class="hl-3">} </span><span class="hl-11">from</span><span class="hl-3"> </span><span class="hl-12">&#39;@matttolman/threads&#39;</span><br/><br/><span class="hl-7">let</span><span class="hl-3"> </span><span class="hl-9">waitGroup</span><span class="hl-3">: </span><span class="hl-14">WaitGroup</span><br/><span class="hl-7">let</span><span class="hl-3"> </span><span class="hl-9">addr</span><span class="hl-3">: </span><span class="hl-14">Address</span><br/><br/><span class="hl-10">oninit</span><span class="hl-3"> = ({</span><span class="hl-9">wg</span><span class="hl-3">, </span><span class="hl-9">mem</span><span class="hl-3">}) </span><span class="hl-7">=&gt;</span><span class="hl-3"> {</span><br/><span class="hl-3">    </span><span class="hl-9">waitGroup</span><span class="hl-3"> = </span><span class="hl-9">wg</span><br/><span class="hl-3">    </span><span class="hl-9">addr</span><span class="hl-3"> = </span><span class="hl-9">mem</span><br/><span class="hl-3">}</span><br/><br/><span class="hl-10">onwork</span><span class="hl-3"> = </span><span class="hl-9">v</span><span class="hl-3"> </span><span class="hl-7">=&gt;</span><span class="hl-3"> {</span><br/><span class="hl-3">    </span><span class="hl-0">// do our part of the work</span><br/><span class="hl-3">    </span><span class="hl-7">const</span><span class="hl-3"> </span><span class="hl-8">vSquare</span><span class="hl-3"> = </span><span class="hl-9">v</span><span class="hl-3"> * </span><span class="hl-9">v</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-0">// atomic add so we don&#39;t have to lock</span><br/><span class="hl-3">    </span><span class="hl-9">addr</span><span class="hl-3">.</span><span class="hl-10">atomicAdd</span><span class="hl-3">(</span><span class="hl-9">vSquare</span><span class="hl-3">)</span><br/><span class="hl-3">    </span><br/><span class="hl-3">    </span><span class="hl-0">// signal that our work is done</span><br/><span class="hl-3">    </span><span class="hl-9">waitGroup</span><span class="hl-3">.</span><span class="hl-10">done</span><span class="hl-3">()</span><br/><span class="hl-3">}</span>
</code><button type="button">Copy</button></pre>

<h2 id="license" class="tsd-anchor-link">License<a href="#license" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2>
<p>Copyright, Matthew Tolman 2026</p>
<p>This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. If a copy of the MPL was not distributed with this file, You can obtain one at <a href="https://mozilla.org/MPL/2.0/">https://mozilla.org/MPL/2.0/</a>.</p>
<h3 id="libraries-distributed-as-part-of-the-test-code" class="tsd-anchor-link">Libraries distributed as part of the test code<a href="#libraries-distributed-as-part-of-the-test-code" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>The copies of Mocha and Chai that are distributed as in the <code>tests/</code> directory are done so under the MIT license. The licenses are at the start of the corresponding files.
These libraries are only used for testing purposes and are not part of the final executable code, or part of the source code for the threads library.
For completeness, their licenses are included in this document.</p>
<h4 id="chai" class="tsd-anchor-link">Chai<a href="#chai" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4>
<pre><code class="text">MIT License

Copyright (c) 2017 Chai.js Assertion Library

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
</code><button type="button">Copy</button></pre>

<h4 id="mocha" class="tsd-anchor-link">Mocha<a href="#mocha" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4>
<pre><code class="text">(The MIT License)

Copyright (c) 2011-2024 OpenJS Foundation and contributors, https://openjsf.org

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
&#39;Software&#39;), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED &#39;AS IS&#39;, WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
</code><button type="button">Copy</button></pre>

</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#threads-js"><span>Threads <wbr/>JS</span></a><ul><li><a href="#general-usage"><span>General <wbr/>Usage</span></a></li><li><a href="#closing-threads"><span>Closing <wbr/>Threads</span></a></li><li><a href="#thread-pool-usage"><span>Thread <wbr/>Pool <wbr/>Usage</span></a></li><li><a href="#sending-classes"><span>Sending classes</span></a></li><li><a href="#seeding-the-thread"><span>Seeding the thread</span></a></li><li><a href="#advanced-usage"><span>Advanced <wbr/>Usage</span></a></li><li><ul><li><a href="#sending-messages-with-no-responses"><span>Sending <wbr/>Messages <wbr/>With <wbr/>No <wbr/>Responses</span></a></li><li><a href="#receiving-events-from-the-thread"><span>Receiving events from the thread</span></a></li><li><a href="#transfering-objects-to-workers"><span>Transfering objects to workers</span></a></li><li><a href="#transferring-objects-back"><span>Transferring objects back</span></a></li><li><a href="#sharing-data"><span>&quot;<wbr/>Sharing&quot; data</span></a></li></ul></li><li><a href="#shared-memory"><span>Shared <wbr/>Memory</span></a></li><li><ul><li><a href="#address"><span>Address</span></a></li><li><a href="#barrier"><span>Barrier</span></a></li><li><a href="#condition-variable"><span>Condition <wbr/>Variable</span></a></li><li><a href="#mutex"><span>Mutex</span></a></li><li><a href="#semaphore"><span>Semaphore</span></a></li><li><a href="#waitgroup"><span>Wait<wbr/>Group</span></a></li></ul></li><li><a href="#license"><span>License</span></a></li><li><ul><li><a href="#libraries-distributed-as-part-of-the-test-code"><span>Libraries distributed as part of the test code</span></a></li><li><ul><li><a href="#chai"><span>Chai</span></a></li><li><a href="#mocha"><span>Mocha</span></a></li></ul></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="modules.html">peaks-threads</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
